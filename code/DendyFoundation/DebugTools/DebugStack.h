////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// -----------------------------------------------------------------------------------------------------------------------------------------------------------
////   \file    DebugStack.h
////   \author  Daniel Huc aka Dendy
////   \date    December 2017
////   -----------------------------
////   \brief   None
////   ---------------------------------------------------------------------------------------------------------------------------------------------------------
////   \details None
//// -----------------------------------------------------------------------------------------------------------------------------------------------------------
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// FIXME: -
////        -
//// -----------------------------------------------------------------------------------------------------------------------------------------------------------
//// TODO:  - FINISH
////        - TEST
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#pragma once

//// - Standard includes section - ////
#include <stack>

//// - External includes section - ////

//// -Foundation includes section- ////
#include "DendyFoundation/Types.h"
#include "DendyFoundation/InputOutput/OutputStreamInterface.h"

//// - Internal includes section - ////

//// - Defines and macro section - ////

#ifndef _DENDYENGINE_LOCATION

// Double macro to display the number of the line instead of "__LINE__"
#define _DENDYENGINE_DISPLAY_VALUE_HELPER_SECOND_PASS(value) #value
#define _DENDYENGINE_DISPLAY_VALUE_HELPER(value) _DENDYENGINE_DISPLAY_VALUE_HELPER_SECOND_PASS(value)

// Define _DENDYENGINE_CURRENT_FUNCTION macro to call __func__ define for c++11 gcc or __FUNCTION__ defined for MSVC!
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< Specific to 'WINDOWS/LINUX' <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
#ifdef DENDYENGINE_PLATFORM_WINDOWS
#define _DENDYENGINE_CURRENT_FUNCTION __FUNCTION__
#endif
#ifdef DENDYENGINE_PLATFORM_LINUX
#define _DENDYENGINE_CURRENT_FUNCTION _DENDYENGINE_DISPLAY_VALUE_HELPER(__PRETTY_FUNCTION__)
#endif
//>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Stack display message (file:function:line)
#define _DENDYENGINE_LOCATION ( __FILE__ "#" _DENDYENGINE_CURRENT_FUNCTION "#" _DENDYENGINE_DISPLAY_VALUE_HELPER(__LINE__) )

#endif

#ifndef _DENDYENGINE_DEFINEGUARD_DEBUG_SYSTEM

////////////////////////////////////////////////////////////
// The actually public interface for the Debug system !!! //
////////////////////////////////////////////////////////////
#ifdef DENDYENGINE_MODE_DEBUG
#define DENDYENGINE_CALLSTACK_ENTER         (&DendyEngine::DendyFoundation::DebugTools::TheDebugStack::getInstance())->enter(_DENDYENGINE_LOCATION)
#define DENDYENGINE_CALLSTACK_EXIT          (&DendyEngine::DendyFoundation::DebugTools::TheDebugStack::getInstance())->exit()
#else
#define DENDYENGINE_CALLSTACK_ENTER         /***/
#define DENDYENGINE_CALLSTACK_EXIT          /***/
#endif
////////////////////////////////////////////////////////////

#define _DENDYENGINE_DEFINEGUARD_DEBUG_SYSTEM
#endif

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//// ---- Namespaces ---- ////
namespace DendyEngine {

   namespace DendyFoundation {

      namespace DebugTools {

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////   Class TheDebugStack                                                                                                                               ////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

         class TheDebugStack {

         ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
         //// ---- Enum/Struct/Constants -----                                                                                                   ////
         ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
         private:
            enum class EEventType {
               DY_BEGIN,
               DY_END,
               DY_LOG,
               DY_ERROR,
               DY_CRITICAL_ERROR
            };

            struct SCodeLocation {
               std::string fileStr;
               std::string functionStr;
               std::string lineStr;
               SCodeLocation( std::string rawLocationStr = "" );
            };

            struct SDebugEvent {
               EEventType    type;
               std::string   messageStr;
               SCodeLocation context;
               SDebugEvent( ):
                  type( EEventType::DY_LOG ),
                  messageStr( "" ),
                  context( "" ) {/***/};
            };

         ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
         //// ---- Members -----                                                                                                                 ////
         ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
         private:
            std::stack<SDebugEvent> m_stack;
            dyInt m_currentLevel;

         ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
         //// ---- Methods -----                                                                                                                 ////
         ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
         private:
         //// ---- Internal ---- ////
            void _dump( );
            void _flush( std::stack<SDebugEvent> a_stackToFlush );

         public:
         //// ----  Object  ---- ////

         //// ----  Static  ---- ////
            static TheDebugStack& getInstance( );
            static void destroyInstance( );

         //// ---- Accessor ---- ////

         //// ----   Core   ---- ////
            void enter( std::string locationStr );
            void exit( );
            void criticalError( std::string messageStr, std::string locationStr );

         };

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////                                                                                                                                                     ////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

      }
   }
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
